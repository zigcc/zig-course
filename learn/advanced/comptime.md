---
outline: deep
---

# ç¼–è¯‘æœŸ

åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆæ¢³ç†ä¸€ä¸‹ï¼Œä»€ä¹ˆæ˜¯**ç¼–è¯‘æœŸ**ï¼Ÿ

å¯¹äºè¿™ä¸ªæ¦‚å¿µï¼Œä½ å¯èƒ½ä¼šä¸€è„¸æ‡µé€¼ã€‚æ‰€ä»¥æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ä»€ä¹ˆæ˜¯è¿è¡Œæ—¶ï¼ˆruntimeï¼‰ï¼š

> â€œåœ¨è®¡ç®—æœºç§‘å­¦ä¸­ä»£è¡¨ä¸€ä¸ªè®¡ç®—æœºç¨‹åºä»å¼€å§‹æ‰§è¡Œåˆ°ç»ˆæ­¢æ‰§è¡Œçš„è¿ä½œã€æ‰§è¡Œçš„æ—¶æœŸã€‚â€

å¯¹åº”åœ°ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•ç»™ç¼–è¯‘æœŸåšä¸€ä¸ªå®šä¹‰ï¼šâ€œzig ç¼–è¯‘æœŸæ˜¯æŒ‡åœ¨ zig ç¼–è¯‘æœŸé—´æ‰§è¡Œçš„åŠ¨ä½œã€‚â€

:::info ğŸ…¿ï¸ æç¤º

åœ¨ Zig ä¸­ï¼Œç±»å‹æ˜¯ä¸€ç­‰å…¬æ°‘ã€‚å®ƒä»¬å¯ä»¥åˆ†é…ç»™å˜é‡ï¼Œä½œä¸ºå‚æ•°ä¼ é€’ç»™å‡½æ•°ï¼Œå¹¶ä»å‡½æ•°è¿”å›ã€‚ä½†éœ€è¦æ³¨æ„ï¼šå®ƒä»¬åªèƒ½ç”¨äºç¼–è¯‘æœŸå·²çŸ¥çš„è¯­å¥æˆ–å‡½æ•°ä¸­ï¼

é€šå¸¸ä¸€ä¸ªç¼–è¯‘æœŸå·²çŸ¥çš„è¯­å¥æˆ–å‡½æ•°å¸¦æœ‰ `comptime` å…³é”®å­—ï¼

:::

`comptime` è¿™ä¸ªå…³é”®å­—è¡¨ç¤ºï¼š

- åœ¨è¿™ä¸ªè°ƒç”¨ç‚¹ï¼Œæ ‡è®°çš„å€¼å¿…é¡»æ˜¯åœ¨ç¼–è¯‘æœŸå·²çŸ¥çš„ï¼Œå¦åˆ™ zig ä¼šæŠ¥å‘Šé”™è¯¯ï¼
- åœ¨å‡½æ•°å®šä¹‰ä¸­ï¼Œè¯¥å€¼ï¼ˆåŒ…æ‹¬å‚æ•°ã€ç±»å‹ï¼‰å¿…é¡»æ˜¯ç¼–è¯‘æœŸå·²çŸ¥çš„ï¼

## ç¼–è¯‘æœŸå‚æ•°å®ç°é¸­å­ç±»å‹

> â€œå½“çœ‹åˆ°ä¸€åªé¸Ÿèµ°èµ·æ¥åƒé¸­å­ã€æ¸¸æ³³èµ·æ¥åƒé¸­å­ã€å«èµ·æ¥ä¹Ÿåƒé¸­å­ï¼Œé‚£ä¹ˆè¿™åªé¸Ÿå°±å¯ä»¥è¢«ç§°ä¸ºé¸­å­ã€‚â€

ä¸€ä¸ªå®ç° max åŠŸèƒ½çš„å‡½æ•°ï¼š

```zig
fn max(comptime T: type, a: T, b: T) T {
    return if (a > b) a else b;
}
```

ä»¥ä¸Šï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒåŒ…å«ä¸€ä¸ªç¼–è¯‘æœŸå‚æ•° `T`ï¼Œè¿™ä¸ª `T` çš„ç±»å‹æ˜¯ `type`ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªç±»å‹ï¼ŒåŒæ—¶å…¶ä»–çš„å‚æ•°å’Œè¿”å›å€¼ç±»å‹ä¹Ÿéƒ½æ˜¯ `T`ï¼Œè¿™æ„å‘³ç€å‚æ•°ç±»å‹ä¸è¿”å›å€¼ç±»å‹æ˜¯ä¸€è‡´çš„ã€‚

å¾ˆæ˜æ˜¾ï¼Œä¸Šè¿°çš„ `max` å‡½æ•°ä»…ä»…åªèƒ½æ¯”è¾ƒæ•´æ•°å’Œæµ®ç‚¹æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ç¨ç¨æ”¹é€ å®ƒä¸€ä¸‹ï¼Œä½¿ä¹‹æ”¯æŒå¸ƒå°”å€¼ï¼š

```zig
fn max(comptime T: type, a: T, b: T) T {
    if (T == bool) {
        return a or b;
    } else if (a > b) {
        return a;
    } else {
        return b;
    }
}
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ`T` æ˜¯ä¸€ä¸ªå‚æ•°ï¼ˆå‚æ•°åœ¨ zig ä¸­å‡æ˜¯åªè¯»çš„ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥æ­£å¸¸æŠŠå®ƒå½“ä½œå¸¸é‡æ¥ä½¿ç”¨ã€‚

:::info ğŸ…¿ï¸ æç¤º

ä¸Šé¢æ“ä½œå¯è¡Œçš„åŸå› ï¼š

å› ä¸ºç¼–è¯‘æœŸä¼šåœ¨ç¼–è¯‘æœŸéšå¼å†…è” `if` è¡¨è¾¾å¼ï¼Œå¹¶ä¸”ä¼šåˆ æ‰æœªä½¿ç”¨çš„åˆ†æ”¯ï¼Œæ‰€ä»¥å½“ä¼ å…¥çš„ `T` æ˜¯ `bool` æ—¶ï¼Œç¼–è¯‘åçš„ç»“æœæ˜¯è¿™ä¸ªæ ·å­ï¼š

```zig
fn max(a: bool, b: bool) bool {
    {
        return a or b;
    }
}
```

è¿™äº›é¢å¤–æœªä½¿ç”¨çš„åˆ†æ”¯åœ¨ç¼–è¯‘æ—¶ä¼šè¢«â€œè£å‰ªæ‰â€ï¼Œåªä¿ç•™è¿è¡Œæ—¶æ‰€éœ€è¦çš„åˆ†æ”¯ã€‚

:::

::: warning

æ³¨æ„ï¼šè¿™ä¹Ÿé€‚ç”¨äº `switch`ã€‚

:::

## ç¼–è¯‘æœŸå˜é‡

å˜é‡å¯ä»¥ä¹Ÿæ ‡è®°ä¸Š `comptime`ï¼Œè¿™è¡¨ç¤ºå˜é‡æ˜¯ç¼–è¯‘æœŸå·²çŸ¥çš„ã€‚è¿™ä¼šé€šçŸ¥ç¼–è¯‘å™¨ï¼Œè¯¥å˜é‡çš„è¯»å–å’Œå†™å…¥å®Œå…¨æ˜¯åœ¨ç¼–è¯‘æœŸæ‰§è¡Œçš„ï¼Œä»»ä½•å‘ç”Ÿè¿è¡Œæ—¶å¯¹å˜é‡çš„æ“ä½œå°†ä¼šåœ¨ç¼–è¯‘æ—¶æŠ¥é”™ã€‚

è¯¥ç‰¹æ€§å¯ä»¥ä¸ `inline` ä¸€èµ·ä½¿ç”¨ï¼Œä»¥ä¸‹çš„ç¤ºä¾‹ä»…ä»…æ˜¯ç¤ºèŒƒä½œç”¨ï¼ˆå®é™…æ²¡æœ‰å¿…è¦è¿™ä¹ˆæ“ä½œï¼‰ï¼š

```zig
const expect = @import("std").testing.expect;

const CmdFn = struct {
    name: []const u8,
    func: fn(i32) i32,
};

const cmd_fns = [_]CmdFn{
    CmdFn {.name = "one", .func = one},
    CmdFn {.name = "two", .func = two},
    CmdFn {.name = "three", .func = three},
};
fn one(value: i32) i32 { return value + 1; }
fn two(value: i32) i32 { return value + 2; }
fn three(value: i32) i32 { return value + 3; }

fn performFn(comptime prefix_char: u8, start_value: i32) i32 {
    var result: i32 = start_value;
    // ä»¥ä¸‹çš„å˜é‡ i è¢«æ ‡è®°ä¸ºç¼–è¯‘æœŸå·²çŸ¥çš„
    comptime var i = 0;
    // ä¸‹é¢çš„ while å¾ªç¯å°†ä¼šè¢«è‡ªåŠ¨å†…è”
    inline while (i < cmd_fns.len) : (i += 1) {
        if (cmd_fns[i].name[0] == prefix_char) {
            result = cmd_fns[i].func(result);
        }
    }
    return result;
}

test "perform fn" {
    try expect(performFn('t', 1) == 6);
    try expect(performFn('o', 0) == 1);
    try expect(performFn('w', 99) == 99);
}
```

é’ˆå¯¹ä¸åŒçš„å‚æ•°ï¼Œå®é™…ä¸Šä¼šåœ¨ç¼–è¯‘æœŸç”Ÿæˆä¸åŒçš„ä»£ç ï¼š

```zig
// expect(performFn('t', 1) == 6);
fn performFn(start_value: i32) i32 {
    var result: i32 = start_value;
    result = two(result);
    result = three(result);
    return result;
}
```

```zig
// expect(performFn('o', 0) == 1);
fn performFn(start_value: i32) i32 {
    var result: i32 = start_value;
    result = one(result);
    return result;
}
```

```zig
// expect(performFn('w', 99) == 99);
fn performFn(start_value: i32) i32 {
    var result: i32 = start_value;
    _ = &result;
    return result;
}
```

:::info ğŸ…¿ï¸ æç¤º

è¿™ç§ç¼–è¯‘æœŸå˜é‡çš„å®ç°ï¼Œæ›´å¤šæ˜¯ä¸ºäº†ä»£æ›¿éœ€è¦ä½¿ç”¨å®ã€ä»£ç ç”Ÿæˆã€é¢„å¤„ç†å™¨çš„åœºæ™¯ã€‚

:::

## ç¼–è¯‘æœŸè¡¨è¾¾å¼

é€šè¿‡ `comptime` æ ‡è®°å‘Šè¯‰ç¼–è¯‘å™¨è¡¨è¾¾å¼éœ€è¦åœ¨ç¼–è¯‘æœŸå®Œæˆè®¡ç®—ï¼Œå¦‚æœæ— æ³•å®Œæˆè®¡ç®—ï¼Œç¼–è¯‘å™¨å°†ä¼šæŠ¥å‘Šé”™è¯¯ã€‚

å¯¹äºä¸€ä¸ªç¼–è¯‘æœŸè¡¨è¾¾å¼ï¼Œå®ƒæœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š

- æ‰€æœ‰å˜é‡éƒ½æ˜¯ `comptime` å˜é‡
- æ‰€æœ‰ `if`ã€`while`ã€`for` å’Œ `switch` è¡¨è¾¾å¼éƒ½åœ¨ç¼–è¯‘æ—¶æ±‚å€¼ï¼Œå¦‚æœä¸å¯èƒ½ï¼Œåˆ™å‘å‡ºç¼–è¯‘é”™è¯¯ã€‚
- æ‰€æœ‰ `return` å’Œ `try` è¡¨è¾¾å¼éƒ½æ˜¯æ— æ•ˆçš„ï¼ˆé™¤éå‡½æ•°æœ¬èº«åœ¨ç¼–è¯‘æ—¶è¢«è°ƒç”¨ï¼‰ã€‚
- æ‰€æœ‰å…·æœ‰è¿è¡Œæ—¶å‰¯ä½œç”¨æˆ–ä¾èµ–äºè¿è¡Œæ—¶å€¼çš„ä»£ç éƒ½ä¼šå‘å‡ºç¼–è¯‘é”™è¯¯ã€‚
- æ‰€æœ‰å‡½æ•°è°ƒç”¨éƒ½ä¼šå¯¼è‡´ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æ—¶è§£é‡Šè¯¥å‡½æ•°ï¼Œå¦‚æœè¯¥å‡½æ•°å°è¯•æ‰§è¡Œå…·æœ‰å…¨å±€è¿è¡Œæ—¶å‰¯ä½œç”¨çš„æ“ä½œï¼Œåˆ™ä¼šå‘å‡ºç¼–è¯‘é”™è¯¯ã€‚

:::info ğŸ…¿ï¸ æç¤º

æ•…æˆ‘ä»¬æ— éœ€ä¸“é—¨ä¸ºç¼–è¯‘æœŸè¡¨è¾¾å¼ç¼–å†™å‡½æ•°ï¼Œåªéœ€è¦ç¼–å†™æ™®é€šçš„å‡½æ•°å°±è¡Œã€‚

:::

```zig
const expect = @import("std").testing.expect;

fn fibonacci(index: u32) u32 {
    if (index < 2) return index;
    return fibonacci(index - 1) + fibonacci(index - 2);
}

test "fibonacci" {
    // test fibonacci at run-time
    try expect(fibonacci(7) == 13);

    // test fibonacci at compile-time
    try comptime expect(fibonacci(7) == 13);
}
```

ä»¥ä¸Šå‡½æ•°å®ç°äº†[æ–æ³¢é‚£å¥‘æ•°åˆ—](https://zh.wikipedia.org/zh-sg/æ–æ³¢é‚£å¥‘æ•°)ï¼Œæ³¨æ„æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯é€’å½’æ–¹æ³•æ¥å®ç°æ–æ³¢é‚£å¥‘æ•°åˆ—æ±‚å€¼ï¼Œåœ¨ç¼–è¯‘æœŸï¼Œå †æ ˆçš„åµŒå¥—å±‚æ•°æœ€å¤§æ˜¯ï¼š1000ï¼Œå¦‚æœè¶…è¿‡äº†è¿™ä¸ªå€¼ï¼Œå¯ä»¥ä½¿ç”¨ [`@setEvalBranchQuota`](https://ziglang.org/documentation/master/#setEvalBranchQuota)ï¼Œæ¥ä¿®æ”¹é»˜è®¤çš„å †æ ˆåµŒå¥—ã€‚

:::info ğŸ…¿ï¸ æç¤º

æ³¨æ„ï¼šå½“å‰çš„è‡ªæ‰˜ç®¡ç¼–è¯‘æœŸè®¾è®¡å­˜åœ¨æŸäº›ç¼ºé™·ï¼ˆä½¿ç”¨è‡ªå·±çš„å †æ ˆè¿›è¡Œcomptimeå‡½æ•°è°ƒç”¨ï¼‰ï¼Œå½“å®¿ä¸»æœºå™¨å¹¶æ²¡æœ‰æä¾›è¶³å¤Ÿå¤§çš„å †æ ˆæ—¶ï¼Œå°†å¯¼è‡´å †æ ˆæº¢å‡ºï¼Œå…·ä½“é—®é¢˜å¯ä»¥è§è¿™ä¸ª[issue](https://github.com/ziglang/zig/issues/13724)ã€‚

:::

åœ¨å®¹å™¨çº§åˆ«ï¼ˆä»»ä½•å‡½æ•°ä¹‹å¤–ï¼‰ï¼Œæ‰€æœ‰è¡¨è¾¾å¼éƒ½æ˜¯éšå¼çš„ `comptime` è¡¨è¾¾å¼ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å‡½æ•°æ¥åˆå§‹åŒ–å¤æ‚çš„é™æ€æ•°æ®ã€‚ä¾‹å¦‚ï¼š

```zig
const c = add_comptime(1, 2);

fn add_comptime(comptime a: usize, comptime b: usize) usize {
    return a + b;
}
```

`add_comptime` å‡½æ•°ä½œä¸ºç¼–è¯‘æœŸå¯æ‰§è¡Œå‡½æ•°ï¼Œæˆ‘ä»¬ç”¨å®ƒæ¥è¿›è¡Œæ•°æ®çš„åˆå§‹åŒ–ï¼Œå½“ç„¶æˆ‘ä»¬è¿™é‡Œå¯ä»¥ç›´æ¥èµ‹å€¼ä¸º `3`ï¼Œè¿™é‡Œä»…ä»…ä½œä¸ºç¤ºä¾‹ã€‚å½“æˆ‘ä»¬åœ¨å¤„ç†å¤æ‚æ•°æ®æ—¶å¾ˆæœ‰ç”¨ã€‚

## ç”Ÿæˆæ•°æ®ç»“æ„

zig æ”¯æŒä»…ä½¿ç”¨ `comptime` æ¥ç”Ÿæˆæ•°æ®ç»“æ„ï¼Œæ— éœ€å¼•å…¥é¢å¤–çš„è¯­æ³•ï¼š

```zig
fn List(comptime T: type) type {
    return struct {
        items: []T,
        len: usize,
    };
}

var buffer: [10]i32 = undefined;
var list = List(i32){
    .items = &buffer,
    .len = 0,
};
```

ä»¥ä¸Šä»£ç ï¼Œæˆ‘ä»¬é€šè¿‡ `List` å‡½æ•°åˆå§‹åŒ–å˜é‡ `list`ï¼Œå®ƒæ˜¯ä¸€ä¸ªç»“æ„ä½“çš„ç¤ºä¾‹ï¼Œ`List(i32)` è¿”å›çš„æ˜¯ä¸€ä¸ªç»“æ„ä½“ç±»å‹ã€‚

:::info ğŸ…¿ï¸ æç¤º

å…³äºè¿™ä¸ªç»“æ„ä½“çš„åå­—ï¼Œå®ƒæ˜¯ç”±ç¼–è¯‘å™¨å†³å®šçš„ï¼Œæ ¹æ®åˆ›å»ºåŒ¿åç»“æ„ä½“æ—¶è°ƒç”¨çš„å‡½æ•°åç§°å’Œå‚æ•°æ¨æ–­å‡ºåç§°ä¸º`List(i32)`ã€‚

:::
