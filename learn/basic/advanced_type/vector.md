---
outline: deep
---

# å‘é‡

> å‘é‡ï¼ˆVectorï¼‰ä¸ºæˆ‘ä»¬æä¾›äº†å¹¶è¡Œæ“çºµä¸€ç»„åŒç±»å‹ï¼ˆå¸ƒå°”ã€æ•´å‹ã€æµ®ç‚¹ã€æŒ‡é’ˆï¼‰çš„å€¼çš„æ–¹æ³•ï¼Œå®ƒå°½å¯èƒ½ä½¿ç”¨ `SIMD` æŒ‡ä»¤ã€‚

## åŸºæœ¬ä½¿ç”¨

å‘é‡æ”¯æŒä¸åº•å±‚åŸºæœ¬ç±»å‹ç›¸åŒçš„å†…ç½®è¿ç®—ç¬¦ã€‚è¿™äº›æ“ä½œæ˜¯æŒ‰å…ƒç´ æ‰§è¡Œï¼Œå¹¶è¿”å›ä¸è¾“å…¥å‘é‡é•¿åº¦ç›¸åŒçš„å‘é‡ï¼ŒåŒ…æ‹¬ï¼š

- ç®—æœ¯è¿ç®—ç¬¦ (`+`, `-`, `/`, `*`, `@divFloor`, `@sqrt`, `@ceil`, `@log`, ... )
- ä½æ“ä½œç¬¦ (`>>`, `<<`, `&`, `|`,`~`, ... )
- æ¯”è¾ƒè¿œç®—ç¬¦ (`<`, `>`, `==`, ...)

ç¦æ­¢å¯¹æ ‡é‡ï¼ˆå•ä¸ªæ•°å­—ï¼‰å’Œå‘é‡çš„æ··åˆä½¿ç”¨æ•°å­¦è¿ç®—ç¬¦ï¼ŒZig æä¾›äº† [`@splat`](https://ziglang.org/documentation/0.11.0/#splat) å†…ç½®å‡½æ•°æ¥è½»æ¾ä»æ ‡é‡è½¬æ¢ä¸ºå‘é‡ï¼Œå¹¶ä¸”å®ƒæ”¯æŒ [`@reduce`](https://ziglang.org/documentation/0.11.0/#reduce) å’Œæ•°ç»„ç´¢å¼•è¯­æ³•ä»¥ä»å‘é‡è½¬æ¢ä¸ºæ ‡é‡ï¼Œå‘é‡è¿˜æ”¯æŒå¯¹å…·æœ‰å·²çŸ¥é•¿åº¦çš„å›ºå®šé•¿åº¦æ•°ç»„è¿›è¡Œèµ‹å€¼ï¼Œå¦‚æœéœ€è¦é‡æ–°æ’åˆ—å…ƒç´ ï¼Œå¯ä»¥ä½¿ç”¨ [`@shuffle`](https://ziglang.org/documentation/0.11.0/#shuffle) å’Œ [`@select`](https://ziglang.org/documentation/0.11.0/#select) å‡½æ•°ã€‚

```zig
const std = @import("std");
const print = std.debug.print;

pub fn main() !void {
    const ele_4 = @Vector(4, i32);

    // å‘é‡å¿…é¡»æ‹¥æœ‰ç¼–è¯‘æœŸå·²çŸ¥çš„é•¿åº¦å’Œç±»å‹
    const a = ele_4{ 1, 2, 3, 4 };
    const b = ele_4{ 5, 6, 7, 8 };

    // æ‰§è¡Œç›¸åŠ çš„æ“ä½œ
    const c = a + b;

    print("Vector c is {any}\n", .{c});
    // ä»¥æ•°ç»„ç´¢å¼•çš„è¯­æ³•æ¥è®¿é—®å‘é‡çš„å…ƒç´ 
    print("the third element of Vector c is {}\n", .{c[2]});

    // å®šä¹‰ä¸€ä¸ªæ•°ç»„ï¼Œæ³¨æ„æˆ‘ä»¬è¿™é‡Œä½¿ç”¨çš„æ˜¯æµ®ç‚¹ç±»å‹
    var arr1: [4]f32 = [_]f32{ 1.1, 3.2, 4.5, 5.6 };
    // ç›´æ¥è½¬æ¢æˆä¸ºä¸€ä¸ªå‘é‡
    const vec: @Vector(4, f32) = arr1;

    print("Vector vec is {any}\n", .{vec});

    // å°†ä¸€ä¸ªåˆ‡ç‰‡è½¬æ¢ä¸ºå‘é‡
    const vec2: @Vector(2, f32) = arr1[1..3].*;
    print("Vector vec2 is {any}\n", .{vec2});
}
```

::: info ğŸ…¿ï¸ æç¤º

å¯ä»¥ä½¿ç”¨ `@as` å°†å‘é‡è½¬ä¸ºæ•°ç»„ã€‚

æ¯”ç›®æ ‡æœºå™¨çš„ SIMD å¤§å°çŸ­çš„å‘é‡çš„æ“ä½œé€šå¸¸ä¼šç¼–è¯‘ä¸ºå•ä¸ª SIMD æŒ‡ä»¤ï¼Œè€Œæ¯”ç›®æ ‡æœºå™¨ SIMD å¤§å°é•¿çš„å‘é‡å°†ç¼–è¯‘ä¸ºå¤šä¸ª SIMD æŒ‡ä»¤ã€‚

å¦‚æœç»™å®šçš„ç›®æ ‡ä½“ç³»æ¶æ„ä¸Šä¸æ”¯æŒ SIMDï¼Œåˆ™ç¼–è¯‘å™¨å°†é»˜è®¤ä¸€æ¬¡å¯¹æ¯ä¸ªå‘é‡å…ƒç´ è¿›è¡Œæ“ä½œã€‚

Zig æ”¯æŒä»»ä½•å·²çŸ¥çš„æœ€å¤§ 2^32-1 å‘é‡é•¿åº¦ã€‚è¯·æ³¨æ„ï¼Œè¿‡é•¿çš„å‘é‡é•¿åº¦ï¼ˆä¾‹å¦‚ 2^20ï¼‰å¯èƒ½ä¼šå¯¼è‡´å½“å‰ç‰ˆæœ¬çš„ Zig ä¸Šçš„ç¼–è¯‘å™¨å´©æºƒã€‚

:::

## `@splat`

`@splat(scalar: anytype) anytype`

ç”Ÿæˆä¸€ä¸ªå‘é‡ï¼Œå‘é‡çš„æ¯ä¸ªå…ƒç´ å‡æ˜¯ä¼ å…¥çš„å‚æ•° `scalar`ï¼Œå‘é‡çš„ç±»å‹å’Œé•¿åº¦ç”±ç¼–è¯‘å™¨æ¨æ–­ã€‚

```zig
const scalar: u32 = 5;
const result: @Vector(4, u32) = @splat(scalar);
```

## `@reduce`

`@reduce(comptime op: std.builtin.ReduceOp, value: anytype) E`

ä½¿ç”¨ä¼ å…¥çš„è¿ç®—ç¬¦å¯¹å‘é‡è¿›è¡Œæ°´å¹³æŒ‰é¡ºåºåˆå¹¶ï¼ˆ_sequential horizontal reduction_ï¼‰ï¼Œæœ€ç»ˆå¾—åˆ°ä¸€ä¸ªæ ‡é‡ã€‚

```zig
const V = @Vector(4, i32);
const value = V{ 1, -1, 1, -1 };

const result = value > @as(V, @splat(0));
// result æ˜¯ { true, false, true, false };

const is_all_true = @reduce(.And, result);
// is_all_true æ˜¯ false
```

::: info ğŸ…¿ï¸ æç¤º

1. æ‰€æœ‰çš„è¿ç®—ç¬¦å‡å¯ç”¨äºæ•´å‹
2. `.And`, `.Or`, `.Xor` è¿˜å¯ç”¨äºå¸ƒå°”ã€‚
3. `.Min`, `.Max`, `.Add`, `.Mul` è¿˜å¯ä»¥ç”¨äºæµ®ç‚¹å‹ã€‚

æ³¨æ„ï¼š`.Add` å’Œ `.Mul` åœ¨æ•´å½¢ä¸Šçš„æ“ä½œæ˜¯ **wrapping**ã€‚

<!-- å¢åŠ è¯´æ˜å…³äºæµ®ç‚¹çš„optimizedè¯´æ˜ -->

:::

## `@shuffle`

```zig
@shuffle(comptime E: type, a: @Vector(a_len, E), b: @Vector(b_len, E), comptime mask: @Vector(mask_len, i32)) @Vector(mask_len, E)
```

æ ¹æ®æ©ç `mask`ï¼ˆä¸€ä¸ªå‘é‡ Vectorï¼‰ï¼Œè¿”å›å‘é‡ a æˆ–è€…å‘é‡ b çš„å€¼ï¼Œç»„æˆä¸€ä¸ªæ–°çš„å‘é‡ï¼Œmask çš„é•¿åº¦å†³å®šè¿”å›çš„å‘é‡çš„é•¿åº¦ï¼Œå¹¶ä¸”é€ä¸ªæ ¹æ® mask ä¸­çš„å€¼ï¼Œæ¥ä» a æˆ– bé€‰å‡ºå€¼ï¼Œæ­£æ•°æ˜¯ä» a é€‰å‡ºæŒ‡å®šç´¢å¼•çš„å€¼ï¼ˆä» 0 å¼€å§‹ï¼Œå˜å¤§ï¼‰ï¼Œè´Ÿæ•°æ˜¯ä» b é€‰å‡ºæŒ‡å®šç´¢å¼•çš„å€¼ï¼ˆä» -1 å¼€å§‹ï¼Œå˜å°ï¼‰ã€‚

::: info ğŸ…¿ï¸ æç¤º

- å»ºè®®å¯¹ b ä¸­çš„ç´¢å¼•ä½¿ç”¨ `~` è¿ç®—ç¬¦ï¼Œä»¥ä¾¿ä¸¤ä¸ªç´¢å¼•éƒ½å¯ä»¥ä» 0 å¼€å§‹ï¼ˆå³ `~@as(i32, 0)` ä¸º -1ï¼‰ã€‚
- å¯¹äºæ¯ä¸ª mask æŒ‘é€‰å‡ºæ¥çš„å…ƒç´ ï¼Œå¦‚æœå®ƒä» A æˆ– B ä¸­çš„é€‰å‡ºçš„å€¼æ˜¯ `undefined`ï¼Œåˆ™ç»“æœå…ƒç´ ä¹Ÿæ˜¯ `undefined`ã€‚
- mask ä¸­çš„å…ƒç´ ç´¢å¼•è¶Šç•Œä¼šäº§ç”Ÿç¼–è¯‘é”™è¯¯ã€‚
- å¦‚æœ a æˆ– b æ˜¯ `undefined`ï¼Œè¯¥å˜é‡é•¿åº¦ç›¸å½“äºå¦ä¸€ä¸ªé `undefined` å˜é‡çš„é•¿åº¦ã€‚å¦‚æœä¸¤ä¸ªå‘é‡å‡æ˜¯ `undefined`ï¼Œåˆ™ `@shuffle` è¿”å›æ‰€æœ‰å…ƒç´ æ˜¯ `undefined` çš„å‘é‡

:::

```zig
const a = @Vector(7, u8){ 'o', 'l', 'h', 'e', 'r', 'z', 'w' };
const b = @Vector(4, u8){ 'w', 'd', '!', 'x' };

const mask1 = @Vector(5, i32){ 2, 3, 1, 1, 0 };
const res1: @Vector(5, u8) = @shuffle(u8, a, undefined, mask1);
// resçš„å€¼æ˜¯ hello

// Combining two vectors
const mask2 = @Vector(6, i32){ -1, 0, 4, 1, -2, -3 };
const res2: @Vector(6, u8) = @shuffle(u8, a, b, mask2);
// res2 çš„å€¼æ˜¯ world!
```

## `@select`

```zig
@select(comptime T: type, pred: @Vector(len, bool), a: @Vector(len, T), b: @Vector(len, T)) @Vector(len, T)
```

æ ¹æ® predï¼ˆä¸€ä¸ªå…ƒç´ å…¨ä¸ºå¸ƒå°”ç±»å‹çš„å‘é‡ï¼‰ä» a æˆ– b ä¸­æŒ‰å…ƒç´ é€‰æ‹©å€¼ã€‚å¦‚æœ `pred[i]` ä¸º `true`ï¼Œåˆ™ç»“æœä¸­çš„ç›¸åº”å…ƒç´ å°†ä¸º `a[i]`ï¼Œå¦åˆ™ä¸º `b[i]`ã€‚

```zig
const ele_4 = @Vector(4, i32);

// å‘é‡å¿…é¡»æ‹¥æœ‰ç¼–è¯‘æœŸå·²çŸ¥çš„é•¿åº¦å’Œç±»å‹
const a = ele_4{ 1, 2, 3, 4 };
const b = ele_4{ 5, 6, 7, 8 };

const pred = @Vector(4, bool){
    true,
    false,
    false,
    true,
};

const c = @select(i32, pred, a, b);
// c æ˜¯ { 1, 6, 7, 4 }
```
