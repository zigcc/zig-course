---
outline: deep
---

# é”™è¯¯å¤„ç†

ç¨‹åºä¼šåœ¨æŸäº›æ—¶å€™å› ä¸ºæŸäº›æˆ‘ä»¬çŸ¥é“æˆ–è€…ä¸çŸ¥é“çš„åŸå› å‡ºé”™ï¼Œæœ‰çš„é”™è¯¯æˆ‘ä»¬å¯ä»¥é¢„çŸ¥å¹¶å¤„ç†ï¼Œæœ‰äº›é”™è¯¯æˆ‘ä»¬æ— æ³•é¢„çŸ¥ï¼Œä½†æˆ‘ä»¬å¯ä»¥æ•è·å®ƒä»¬å¹¶æœ‰æ•ˆåœ°æŠ¥å‘Šç»™ç”¨æˆ·ã€‚

:::info ğŸ…¿ï¸ æç¤º

äº‹å®ä¸Šï¼Œç›®å‰ zig çš„é”™è¯¯å¤„ç†æ–¹æ¡ˆç¬”è€…è®¤ä¸ºæ˜¯æ¯”è¾ƒç®€é™‹çš„ï¼Œå› ä¸ºé”™è¯¯ç±»å‹åœ¨ zig ä¸­åªæ˜¯ç•¥å¾®åŠ å·¥åçš„ `enum`ï¼Œè¿™å¯¼è‡´é”™è¯¯ç±»å‹æ— æ³•æºå¸¦æœ‰æ•ˆçš„ `payload`ï¼Œä½ åªèƒ½é€šè¿‡ error çš„ tagName æ¥è·å–æœ‰æ•ˆçš„ä¿¡æ¯ã€‚

:::

ä»¥ä¸‹å±•ç¤ºäº† error çš„åŸºæœ¬å®šä¹‰å’Œä½¿ç”¨ï¼š

```zig
const std = @import("std");

const FileOpenError = error{
    AccessDenied,
    OutOfMemory,
    FileNotFound,
};

const AllocationError = error{
    OutOfMemory,
};

pub fn main() !void {
    const err = foo(AllocationError.OutOfMemory);
    if (err == FileOpenError.OutOfMemory) {
        std.debug.print("error is OutOfMemory\n", .{});
    }
}

fn foo(err: AllocationError) FileOpenError {
    return err;
}
```

ä»¥ä¸Šä»£ç ä½¿ç”¨ `error` å…³é”®å­—å®šä¹‰äº†ä¸¤ä¸ªé”™è¯¯ç±»å‹ï¼Œåˆ†åˆ«æ˜¯ï¼š`FileOpenError` å’Œ `AllocationError`ï¼Œè¿™ä¸¤ä¸ªç±»å‹å®ç°äº†å‡ ç§é”™è¯¯çš„å®šä¹‰ã€‚

æ³¨æ„ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰å¤šä¸ªé‡å¤çš„é”™è¯¯ tagNameï¼Œå®ƒä»¬å‡ä¼šåˆ†é…ä¸€ä¸ªå¤§äº 0 çš„å€¼ï¼Œå¤šä¸ªé‡å¤çš„é”™è¯¯ tagName çš„å€¼æ˜¯ç›¸åŒçš„ï¼ŒåŒæ—¶ error è¿˜æ”¯æŒå°†é”™è¯¯ä»å­é›†è½¬æ¢åˆ°è¶…é›†ï¼Œè¿™é‡Œæˆ‘ä»¬å°±æ˜¯å°†å­é›† `AllocationError` é€šè¿‡å‡½æ•° `foo` è½¬æ¢åˆ°è¶…é›† `FileOpenError`ã€‚

## åªæœ‰ä¸€ä¸ªå€¼çš„é”™è¯¯é›†

å¦‚æœä½ æ‰“ç®—å®šä¹‰ä¸€ä¸ªåªæœ‰ä¸€ä¸ªå€¼çš„é”™è¯¯é›†ï¼Œæˆ‘ä»¬è¿™æ—¶å†ä½¿ç”¨ä»¥ä¸Šçš„å®šä¹‰æ–¹æ³•æœªå…è¿‡äºå•°å—¦ï¼Œzig æä¾›äº†ä¸€ç§ç®€çŸ­æ–¹å¼æ¥å®šä¹‰ï¼š

```zig
const err = error.FileNotFound;
```

ä»¥ä¸Šè¿™è¡Œä»£ç ç›¸å½“äºï¼š

```zig
const err = (error {FileNotFound}).FileNotFound;
```

## å…¨å±€é”™è¯¯é›†

`anyerror` æŒ‡çš„æ˜¯å…¨å±€çš„é”™è¯¯é›†åˆï¼Œå®ƒåŒ…å«ç¼–è¯‘å•å…ƒä¸­çš„æ‰€æœ‰é”™è¯¯é›†ï¼Œå³è¶…é›†ä¸æ˜¯å­é›†ã€‚

ä½ å¯ä»¥å°†æ‰€æœ‰çš„é”™è¯¯å¼ºåˆ¶è½¬æ¢åˆ° `anyerror`ï¼Œä¹Ÿå¯ä»¥å°† `anyerror` è½¬æ¢åˆ°æ‰€æœ‰é”™è¯¯é›†ï¼Œå¹¶åœ¨è½¬æ¢æ—¶å¢åŠ ä¸€ä¸ªè¯­è¨€çº§æ–­è¨€ï¼ˆlanguage-level assertï¼‰ä¿è¯é”™è¯¯ä¸€å®šæ˜¯ç›®æ ‡é”™è¯¯é›†çš„å€¼ã€‚

::: warning âš ï¸ è­¦å‘Š

åº”å°½é‡é¿å…ä½¿ç”¨ `anyerror`ï¼Œå› ä¸ºå®ƒä¼šé˜»æ­¢ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æœŸå°±æ£€æµ‹å‡ºå¯èƒ½å­˜åœ¨çš„é”™è¯¯ï¼Œå¢åŠ ä»£ç å‡ºé”™ debug çš„è´Ÿæ‹…ã€‚

:::

## é”™è¯¯è”åˆç±»å‹

ï¼ï¼ï¼ä»¥ä¸Šæ‰€è¯´çš„é”™è¯¯ç±»å‹å®é™…ä¸Šç”¨çš„å¤§æ¦‚ä¸å¤šï¼Œä½†é”™è¯¯è”åˆç±»å‹å¤§æ¦‚æ˜¯ä½ ç»å¸¸ç”¨çš„ã€‚

åªéœ€è¦åœ¨æ™®é€šç±»å‹çš„å‰é¢å¢åŠ ä¸€ä¸ª `!` å°±æ˜¯ä»£è¡¨è¿™ä¸ªç±»å‹å˜æˆé”™è¯¯è”åˆç±»å‹ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„å‡½æ•°ï¼š

ä»¥ä¸‹æ˜¯ä¸€ä¸ªå°†è‹±æ–‡å­—ç¬¦ä¸²è§£æä¸ºæ•°å­—çš„ç¤ºä¾‹ï¼š

```zig
const std = @import("std");
const maxInt = std.math.maxInt;

pub fn parseU64(buf: []const u8, radix: u8) !u64 {
    var x: u64 = 0;

    for (buf) |c| {
        const digit = charToDigit(c);

        if (digit >= radix) {
            return error.InvalidChar;
        }

        // x *= radix
        var ov = @mulWithOverflow(x, radix);
        if (ov[1] != 0) return error.OverFlow;

        // x += digit
        ov = @addWithOverflow(ov[0], digit);
        if (ov[1] != 0) return error.OverFlow;
        x = ov[0];
    }

    return x;
}

fn charToDigit(c: u8) u8 {
    return switch (c) {
        '0' ... '9' => c - '0',
        'A' ... 'Z' => c - 'A' + 10,
        'a' ... 'z' => c - 'a' + 10,
        else => maxInt(u8),
    };
}
```

æ³¨æ„å‡½æ•°çš„è¿”å›å€¼ï¼š`!u64`ï¼Œè¿™æ„å‘³å‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ª `u64` æˆ–è€…æ˜¯ä¸€ä¸ª `error`ï¼Œé”™è¯¯é›†åœ¨è¿™é‡Œè¢«ä¿ç•™åœ¨ `!` å·¦ä¾§ï¼Œå› æ­¤è¯¥é”™è¯¯é›†æ˜¯å¯ä»¥è¢«ç¼–è¯‘å™¨è‡ªåŠ¨æ¨å¯¼çš„ã€‚

äº‹å®ä¸Šï¼Œå‡½æ•°æ— è®ºæ˜¯è¿”å› `u64` è¿˜æ˜¯è¿”å› `error`ï¼Œå‡ä¼šè¢«è½¬æ¢ä¸º `anyerror!u64`ã€‚

è¯¥å‡½æ•°çš„å…·ä½“æ•ˆæœå–å†³äºæˆ‘ä»¬å¦‚ä½•å¯¹å¾…è¿”å›çš„ `error`:

1. è¿”å›é”™è¯¯æ—¶æˆ‘ä»¬å‡†å¤‡ä¸€ä¸ªé»˜è®¤å€¼
2. è¿”å›é”™è¯¯æ—¶æˆ‘ä»¬æƒ³å°†å®ƒå‘ä¸Šä¼ é€’
3. ç¡®ä¿¡æœ¬æ¬¡å‡½æ•°æ‰§è¡Œåè‚¯å®šä¸ä¼šå‘ç”Ÿé”™è¯¯ï¼Œæƒ³è¦æ— æ¡ä»¶çš„è§£æ„å®ƒ
4. é’ˆå¯¹ä¸åŒçš„é”™è¯¯é‡‡å–ä¸åŒçš„å¤„ç†æ–¹å¼

### `catch`

`catch` ç”¨äºå‘ç”Ÿé”™è¯¯æ—¶æä¾›ä¸€ä¸ªé»˜è®¤å€¼ï¼Œæ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š

```zig
// æ¥ç€ä¸Šé¢çš„å‡½æ•°å†™

fn doAThing(str: []u8) void {
    const number = parseU64(str, 10) catch 13;
    _ = number; // ...
}
```

`number` å°†ä¸€å®šæ˜¯ä¸€ä¸ª `u64` çš„å€¼ï¼Œå½“å‘ç”Ÿé”™è¯¯æ—¶ï¼Œå°†ä¼šæä¾›é»˜è®¤å€¼ 13 ç»™ `number`ã€‚

:::info ğŸ…¿ï¸ æç¤º

`catch` è¿ç®—ç¬¦å³ä¾§å¿…é¡»æ˜¯ä¸€ä¸ªä¸å…¶å·¦ä¾§å‡½æ•°è¿”å›çš„é”™è¯¯è”åˆç±»å‹å±•å¼€åçš„ç±»å‹ä¸€è‡´ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ª `noreturn`(ä¾‹å¦‚panic) çš„è¯­å¥ã€‚

:::

å½“ç„¶è¿›é˜¶ç‚¹æˆ‘ä»¬è¿˜å¯ä»¥å’Œå‘½åï¼ˆnamed Blocksï¼‰åŠŸèƒ½ç»“åˆèµ·æ¥ï¼š

```zig
// æ¥ç€ä¸Šé¢çš„å‡½æ•°å†™

const number = parseU64(str, 10) catch blk: {
    // do things
    break :blk 13;
};
```

### try

`try` ç”¨äºåœ¨å‡ºç°é”™è¯¯æ—¶ç›´æ¥å‘ä¸Šå±‚è¿”å›é”™è¯¯ï¼Œæ²¡é”™è¯¯å°±æ­£å¸¸æ‰§è¡Œï¼š

::: code-group

```zig [try]
fn doAThing(str: []u8) !void {
    const number = try parseU64(str, 10);
    _ = number; // ...
}
```

```zig [catch å®ç°]
fn doAThing(str: []u8) !void {
    const number = parseU64(str, 10) catch |err| return err;
    _ = number; // ...
}
```

:::

`try` ä¼šå°è¯•è®¡ç®—è”åˆç±»å‹è¡¨è¾¾å¼ï¼Œå¦‚æœæ˜¯é”™è¯¯ä»å½“å‰å‡½æ•°å‘ä¸Šè¿”å›ï¼Œå¦åˆ™è§£æ„å®ƒã€‚

::: info ğŸ…¿ï¸ æç¤º

é‚£ä¹ˆå¦‚ä½•å‡å®šå‡½æ•°ä¸ä¼šè¿”å›é”™è¯¯å‘¢ï¼Ÿ

ä½¿ç”¨ `unreachable`ï¼Œè¿™ä¼šå‘Šè¯‰ç¼–è¯‘å™¨æ­¤æ¬¡å‡½æ•°æ‰§è¡Œä¸ä¼šè¿”å›é”™è¯¯ï¼Œ`unreachable` åœ¨ `Debug` å’Œ `ReleaseSafe` æ¨¡å¼ä¸‹ä¼šäº§ç”Ÿææ…Œï¼Œåœ¨ `ReleaseFast` å’Œ `ReleaseSmall` æ¨¡å¼ä¸‹ä¼šäº§ç”Ÿæœªå®šä¹‰çš„è¡Œä¸ºã€‚æ‰€ä»¥å½“è°ƒè¯•åº”ç”¨ç¨‹åºæ—¶ï¼Œå¦‚æœå‡½æ•°æ‰§è¡Œåˆ°äº†è¿™é‡Œï¼Œé‚£å°±ä¼šå‘ç”Ÿ `panic`ã€‚

```zig
const number = parseU64("1234", 10) catch unreachable;
```

:::

::: details æ›´åŠ è¿›é˜¶çš„é”™è¯¯å¤„ç†æ–¹æ¡ˆ

æœ‰æ—¶æˆ‘ä»¬éœ€è¦é’ˆå¯¹ä¸åŒçš„é”™è¯¯åšæ›´ä¸ºç»†è‡´çš„å¤„ç†ï¼Œè¿™æ—¶æˆ‘ä»¬å¯ä»¥å°† `if` å’Œ `switch` è”åˆèµ·æ¥ï¼š

```zig
fn doAThing(str: []u8) void {
    if (parseU64(str, 10)) |number| {
        doSomethingWithNumber(number);
    } else |err| switch (err) {
        error.Overflow => {
            // å¤„ç†æº¢å‡º
        },
        // æ­¤å¤„å‡å®šè¿™ä¸ªé”™è¯¯ä¸ä¼šå‘ç”Ÿ
        error.InvalidChar => unreachable,
        // è¿™é‡Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ else æ¥æ•è·é¢å¤–çš„é”™è¯¯
        // else => |leftover_err| return leftover_err,
    }
}
```

:::

::: details ä¸å¤„ç†é”™è¯¯

å¦‚æœä¸æƒ³å¤„ç†é”™è¯¯æ€ä¹ˆåŠå‘¢ï¼Ÿ

ç›´æ¥åœ¨æ•è·é”™è¯¯çš„åœ°æ–¹ä½¿ç”¨ `_` æ¥é€šçŸ¥ç¼–è¯‘å™¨å¿½ç•¥å®ƒå³å¯ã€‚

```zig
fn doADifferentThing(str: []u8) void {
    if (parseU64(str, 10)) |number| {
        doSomethingWithNumber(number);
    } else |_| {
        // ä½ ä¹Ÿå¯ä»¥åœ¨è¿™é‡Œåšç‚¹é¢å¤–çš„äº‹æƒ…
    }
}
```

:::

### errdefer

### åˆå¹¶å’Œæ¨æ–­é”™è¯¯

## å †æ ˆè·Ÿè¸ª